<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Редактировать профиль — MovieTracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Стили -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/edit_profile.css') }}">
  <style>
    /* Лёгкий локальный штрих: превью аватара рядом с подписью */
    .avatar-preview {
      display: flex; align-items: center; gap: .75rem;
      margin-top: .35rem;
    }
    .avatar-preview__img {
      width: 56px; height: 56px; border-radius: 50%;
      object-fit: cover; border: 1px solid #222;
    }
  </style>
</head>
<header>
<header>
  <!-- ЛОГОТИП / ССЫЛКА НА ГЛАВНУЮ -->
  <a href="{{ url_for('index') }}" class="header-logo">Rewatch</a>

  <!-- НАВИГАЦИЯ -->
  <nav>
    <a href="{{ url_for('catalog') }}">Каталог</a>
    <a href="{{ url_for('my_list') }}">Мой список</a>
    <a href="{{ url_for('stats') }}">Статистика</a>
    <a href="{{ url_for('profile') }}" class="active">Профиль</a>
  </nav>
</header>
</header>
<body class="page-auth">
  <div class="auth-card">
    <div class="auth-card__header">
      <h1 class="auth-card__title">Редактировать профиль</h1>
      <p class="auth-card__subtitle">Обновите свои данные</p>
    </div>

    <div class="auth-card__body">
      {% with msgs = get_flashed_messages(with_categories=true) %}
        {% if msgs %}
          {% for cat, m in msgs %}
            <div class="flash {{ cat }}">{{ m }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <!-- ВАЖНО: добавили enctype для загрузки файлов -->
      <form class="auth-form" method="post" action="{{ url_for('edit_profile') }}"
            autocomplete="on" enctype="multipart/form-data">
        {# Если используешь CSRF (Flask-WTF), раскомментируй: {{ form.csrf_token }} или {{ csrf_token() }} #}

        <div class="form-row">
          <label class="form-label" for="username">Логин</label>
          <input class="form-input" id="username" name="username"
                 value="{{ user.username }}" required autocomplete="username" placeholder="ваш_логин">
        </div>

        <div class="form-row">
          <label class="form-label" for="email">Email</label>
          <input class="form-input" id="email" type="email" name="email"
                 value="{{ user.email or '' }}" autocomplete="email" placeholder="you@example.com">
        </div>

        <div class="form-row">
          <label class="form-label" for="password">Новый пароль (необязательно)</label>
          <input class="form-input" id="password" type="password" name="password"
                 placeholder="Оставьте пустым, чтобы не менять" autocomplete="new-password">
          <small class="form-help">Если поле пустое — пароль останется прежним.</small>
        </div>

        <!-- URL аватарки + превью (оставляем, чтобы можно было ставить внешнюю ссылку) -->
        <div class="form-row">
          <label class="form-label" for="avatar_url">Ссылка на аватар</label>
          <input class="form-input" id="avatar_url" name="avatar_url"
                 value="{{ user.avatar_url or '' }}" placeholder="https://.../avatar.jpg" autocomplete="url">
          <div class="avatar-preview">
            <img id="avatarPreviewImg"
                 class="avatar-preview__img"
                 src="{{ user.avatar_url or 'https://i.pravatar.cc/150' }}"
                 alt="Превью аватара">
            <small class="form-help">Текущее изображение профиля</small>
          </div>
        </div>

        <!-- НОВОЕ: загрузка файла аватара -->
        <div class="form-row">
          <label class="form-label" for="avatar_file">Загрузить аватар (файл)</label>
          <input class="form-input" id="avatar_file" name="avatar_file" type="file"
                 accept=".png,.jpg,.jpeg,.gif,.webp">
          <small class="form-help">До 2 МБ. Поддержка: PNG, JPG, JPEG, GIF, WEBP.</small>
        </div>
        <!-- /НОВОЕ -->

        <div class="form-actions">
          <button class="btn-primary" type="submit">Сохранить</button>
          <p class="auth-meta"><a class="auth-link" href="{{ url_for('profile') }}">Отмена</a></p>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Превью: поддержка и URL, и локального файла
    (function () {
      const urlInput = document.getElementById('avatar_url');
      const fileInput = document.getElementById('avatar_file');
      const img = document.getElementById('avatarPreviewImg');
      if (!img) return;

      const fallback = '{{ user.avatar_url or "https://i.pravatar.cc/150" }}';

      function updateFromUrl() {
        if (!urlInput) return;
        const url = (urlInput.value || '').trim();
        // Если файл выбран, приоритет у файла — не трогаем превью
        if (fileInput && fileInput.files && fileInput.files.length) return;
        img.src = url || fallback;
      }

      function updateFromFile() {
        const f = fileInput?.files?.[0];
        if (f) {
          img.src = URL.createObjectURL(f);
        } else {
          updateFromUrl();
        }
      }

      urlInput && urlInput.addEventListener('input', updateFromUrl);
      urlInput && urlInput.addEventListener('blur', updateFromUrl);
      fileInput && fileInput.addEventListener('change', updateFromFile);
    })();
  </script>
</body>
</html>
