<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Моя статистика — Rewatch</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/pages.css') }}">

  <style>
    /* Небольшие стили только для этой страницы */
    .stats-cards{
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px,1fr));
      gap: var(--gap,16px);
      margin-bottom: 18px;
    }
    .stats-card{
      background: var(--surface, #181818);
      border: 1px solid var(--border, #222);
      border-radius: var(--radius,12px);
      padding: 14px;
      box-shadow: var(--shadow, 0 12px 32px rgba(0,0,0,.35));
    }
    .stats-card h4{ margin: 0 0 6px 0; color: var(--accent,#5b7abd); }
    .stat-num{
      font-size: 1.8rem; font-weight: 700; line-height: 1.1;
    }
    .muted{ color: var(--muted,#a9a9a9); font-size: .95rem; }

    /* Полоски-диаграммы для статусов/типов */
    .bar{
      background: var(--surface-2, #141414);
      border: 1px solid var(--border, #222);
      border-radius: 10px;
      overflow: hidden;
      height: 10px;
    }
    .bar-fill{ height: 100%; background: var(--accent,#5b7abd); width: 0; transition: width .4s ease; }
    .row{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .label{ color: var(--text,#e0e0e0); font-size:.95rem; }
    .value{ color: var(--muted,#a9a9a9); font-size:.9rem; min-width: 42px; text-align: right; }

    /* Секции */
    .section{ margin: 18px 0 6px; }
    .section h3{ margin: 0 0 10px 0; color: var(--accent,#5b7abd); }

    /* Используем уже готовые card/grid из pages.css для списков тайтлов */
  </style>
</head>
<body>
  <header>
    <a href="{{ url_for('index') }}" class="header-logo">Rewatch</a>
    <nav>
      <a href="{{ url_for('catalog') }}">Каталог</a>
      <a href="{{ url_for('my_list') }}">Мой список</a>
      <a href="{{ url_for('stats') }}" class="active">Статистика</a>
      <a href="{{ url_for('profile') }}">Профиль</a>
    </nav>
  </header>

  <main class="container">
    <div class="toolbar">
      <h1>Моя статистика</h1>
    </div>

    <!-- Верхние карточки-метрики -->
    <div class="stats-cards">
      <div class="stats-card">
        <h4>Всего в библиотеке</h4>
        <div class="stat-num">{{ total }}</div>
        <div class="muted">Количество тайтлов в UserMedia</div>
      </div>
      <div class="stats-card">
        <h4>С оценкой</h4>
        <div class="stat-num">{{ rated_count }}</div>
        <div class="muted">Поставлена пользовательская оценка</div>
      </div>
      <div class="stats-card">
        <h4>Средняя оценка</h4>
        <div class="stat-num">{{ avg_rating if avg_rating is not none else '—' }}</div>
        <div class="muted">По всем оценённым</div>
      </div>
      <div class="stats-card">
        <h4>По типам</h4>
        <div class="row">
          <span class="label">Фильмы</span><span class="value">{{ by_type.movie }}</span>
        </div>
        <div class="bar" aria-hidden="true">
          {% set pct_movie = (by_type.movie / total * 100) if total else 0 %}
          <div class="bar-fill" style="width: {{ '%.2f'|format(pct_movie) }}%"></div>
        </div>
        <div class="row" style="margin-top:8px;">
          <span class="label">Сериалы</span><span class="value">{{ by_type.tv }}</span>
        </div>
        <div class="bar" aria-hidden="true">
          {% set pct_tv = (by_type.tv / total * 100) if total else 0 %}
          <div class="bar-fill" style="width: {{ '%.2f'|format(pct_tv) }}%"></div>
        </div>
      </div>
    </div>

    <!-- Распределение по статусам -->
    <div class="section">
      <h3>Статусы</h3>
      <div class="stats-cards" style="grid-template-columns: 1fr 1fr;">
        <div class="stats-card">
          {% set sc = status_counts %}
          {% set s_total = sc.planned + sc.watching + sc.completed + sc.dropped %}
          <div class="row"><span class="label">Planned</span><span class="value">{{ sc.planned }}</span></div>
          <div class="bar"><div class="bar-fill" style="width: {{ (sc.planned / s_total * 100) if s_total else 0 }}%"></div></div>

          <div class="row" style="margin-top:8px;"><span class="label">Watching</span><span class="value">{{ sc.watching }}</span></div>
          <div class="bar"><div class="bar-fill" style="width: {{ (sc.watching / s_total * 100) if s_total else 0 }}%"></div></div>
        </div>
        <div class="stats-card">
          <div class="row"><span class="label">Completed</span><span class="value">{{ sc.completed }}</span></div>
          <div class="bar"><div class="bar-fill" style="width: {{ (sc.completed / s_total * 100) if s_total else 0 }}%"></div></div>

          <div class="row" style="margin-top:8px;"><span class="label">Dropped</span><span class="value">{{ sc.dropped }}</span></div>
          <div class="bar"><div class="bar-fill" style="width: {{ (sc.dropped / s_total * 100) if s_total else 0 }}%"></div></div>
        </div>
      </div>
      <div class="muted">Статусы берутся из UserMedia.status: planned / watching / completed / dropped.</div>
    </div>

    <!-- Недавнее -->
    <div class="section">
      <h3>Недавние</h3>
      {% if recent_items %}
        <div class="grid">
          {% for it in recent_items %}
            <a class="card" href="{{ it.href }}">
              {% if it.poster %}
                <img class="poster" src="{{ it.poster }}" alt="{{ it.title }}">
              {% else %}
                <div class="poster placeholder">Нет постера</div>
              {% endif %}
              <div class="meta">
                <div class="title">{{ it.title }}</div>
                <div class="sub">
                  {{ it.year }}
                  {% if it.media_type == 'tv' %} • Сериал{% else %} • Фильм{% endif %}
                  {% if it.rating_user %} • ⭐ {{ it.rating_user }}/10{% endif %}
                </div>
              </div>
            </a>
          {% endfor %}
        </div>
      {% else %}
        <div class="empty-state">Нет недавних элементов.</div>
      {% endif %}
    </div>

    <!-- Топ по оценке -->
    <div class="section">
      <h3>Топ по оценке</h3>
      {% if top_items %}
        <div class="grid">
          {% for it in top_items %}
            <a class="card" href="{{ it.href }}">
              {% if it.poster %}
                <img class="poster" src="{{ it.poster }}" alt="{{ it.title }}">
              {% else %}
                <div class="poster placeholder">Нет постера</div>
              {% endif %}
              <div class="meta">
                <div class="title">{{ it.title }}</div>
                <div class="sub">
                  {{ it.year }}
                  {% if it.media_type == 'tv' %} • Сериал{% else %} • Фильм{% endif %}
                  {% if it.rating_user %} • ⭐ {{ it.rating_user }}/10{% endif %}
                </div>
              </div>
            </a>
          {% endfor %}
        </div>
      {% else %}
        <div class="empty-state">Пока нет оценённых тайтлов.</div>
      {% endif %}
    </div>
  </main>

  <footer>
    <p>© 2025 Rewatch</p>
  </footer>
</body>
</html>
